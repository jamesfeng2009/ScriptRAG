-- ============================================================================
-- 主数据库设置脚本
-- 按正确顺序执行所有数据库初始化脚本
-- ============================================================================

-- 使用方法：
-- psql -U screenplay_user -d screenplay_db -f scripts/setup_database.sql

\echo '============================================================================'
\echo '开始数据库设置...'
\echo '============================================================================'
\echo ''

-- ============================================================================
-- 1. 初始化数据库和扩展
-- ============================================================================
\echo '步骤 1/6: 初始化数据库和扩展...'
\i scripts/init_db.sql
\echo '✓ 数据库初始化完成'
\echo ''

-- ============================================================================
-- 2. 创建核心业务表
-- ============================================================================
\echo '步骤 2/6: 创建核心业务表...'
\i scripts/create_core_tables.sql
\echo '✓ 核心业务表创建完成'
\echo ''

-- ============================================================================
-- 3. 创建向量存储表
-- ============================================================================
\echo '步骤 3/6: 创建向量存储表...'
\i scripts/create_vector_tables.sql
\echo '✓ 向量存储表创建完成'
\echo ''

-- ============================================================================
-- 4. 创建日志和审计表
-- ============================================================================
\echo '步骤 4/6: 创建日志和审计表...'
\i scripts/create_log_tables.sql
\echo '✓ 日志和审计表创建完成'
\echo ''

-- ============================================================================
-- 5. 创建数据库函数
-- ============================================================================
\echo '步骤 5/6: 创建数据库函数...'
\i scripts/create_functions.sql
\echo '✓ 数据库函数创建完成'
\echo ''

-- ============================================================================
-- 6. 应用性能优化配置
-- ============================================================================
\echo '步骤 6/6: 应用性能优化配置...'
\i scripts/performance_optimization.sql
\echo '✓ 性能优化配置完成'
\echo ''

-- ============================================================================
-- 验证安装
-- ============================================================================
\echo '============================================================================'
\echo '验证数据库设置...'
\echo '============================================================================'
\echo ''

-- 检查扩展
\echo '已安装的扩展：'
SELECT extname, extversion FROM pg_extension WHERE extname IN ('vector', 'uuid-ossp');
\echo ''

-- 检查表
\echo '已创建的表：'
SELECT schemaname, tablename 
FROM pg_tables 
WHERE schemaname = 'screenplay'
ORDER BY tablename;
\echo ''

-- 检查函数
\echo '已创建的函数：'
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_schema = 'screenplay'
ORDER BY routine_name;
\echo ''

-- 检查视图
\echo '已创建的视图：'
SELECT table_name
FROM information_schema.views
WHERE table_schema = 'screenplay'
ORDER BY table_name;
\echo ''

-- 显示表大小
\echo '表大小统计：'
SELECT * FROM table_sizes;
\echo ''

-- ============================================================================
-- 完成
-- ============================================================================
\echo '============================================================================'
\echo '数据库设置完成！'
\echo '============================================================================'
\echo ''
\echo '下一步：'
\echo '1. 检查 postgresql.conf 中的系统级配置（需要重启数据库）'
\echo '2. 配置 PgBouncer 连接池（可选）'
\echo '3. 设置定期维护任务（VACUUM, ANALYZE）'
\echo '4. 配置备份策略'
\echo '5. 开始索引代码文档'
\echo ''
\echo '有用的命令：'
\echo '  - 分析所有表: SELECT analyze_all_tables();'
\echo '  - 查看表大小: SELECT * FROM table_sizes;'
\echo '  - 查看索引使用: SELECT * FROM index_usage;'
\echo '  - 查看缓存命中率: SELECT * FROM cache_hit_ratio;'
\echo '  - 清理旧日志: SELECT * FROM cleanup_old_logs(90);'
\echo ''
